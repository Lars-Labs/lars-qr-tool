<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lars QR Generator</title>
  <meta name="theme-color" content="#238636">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <script src="theme.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>

<header>
  <a href="index.html" id="homeBtn">‚Üê Home</a>
  <span class="page-title" data-t="generator">QR GENERATOR</span>
  <a href="lars-qr.apk" download class="apk-download-btn">Download APK</a>
  <div id="headerRight">
    <div id="larsButton">
      <img src="lars-logo.png" alt="Lars" id="larsLogoImg">
    </div>
    <div id="actualSettingsBtn">‚öôÔ∏è</div>
  </div>
</header>

<div class="container">
  <div class="card">
    <textarea id="text" placeholder="Enter text or URL" rows="5"></textarea>
    
    <div style="margin: 16px 0;">
      <label style="display:block; margin-bottom:8px; color:var(--text-color);">Embed Logo (optional)</label>
      <input type="file" id="logoUpload" accept="image/*" style="display:none;">
      <button class="secondary" onclick="document.getElementById('logoUpload').click()">Choose Logo</button>
      <button class="secondary" onclick="clearLogo()">Clear Logo</button>
    </div>

    <button onclick="generate()">Generate QR</button>
    <button class="secondary" onclick="pasteText()">Paste from Clipboard</button>
    <button class="secondary" onclick="downloadQR()">Download PNG</button>
    <button class="secondary" onclick="shareQR()">Share QR</button>
  </div>
  <div class="card qr-output-card">
    <div id="qrcode"></div>
  </div>
</div>

<nav>
  <a href="scanner.html" data-t="scan">Scan</a>
  <a class="active" href="generator.html" data-t="create">Create</a>
  <a href="history.html" data-t="historyNav">History</a>
</nav>

<div id="larsMenu">
  <button onclick="openFeedback()">üìù Send Feedback</button>
  <button onclick="openAbout()">‚ÑπÔ∏è About</button>
  <button onclick="openDonate()">‚òï Support on Buy Me a Coffee</button>
</div>

<div id="actualSettingsPanel">
  <h3 data-t="settings">Settings</h3>
  <label data-t="theme">Theme</label>
  <select id="themeSelect">
    <option value="dark">Dark</option>
    <option value="darkgrey">Dark Grey</option>
    <option value="grey">Grey</option>
    <option value="light">Light</option>
  </select>
  <label data-t="language">Language</label>
  <select id="langSelect">
    <option value="en">English</option>
    <option value="es">Espa√±ol</option>
    <option value="fr">Fran√ßais</option>
    <option value="de">Deutsch</option>
    <option value="zh">‰∏≠Êñá</option>
  </select>
  <label>QR Code Color</label>
  <input type="color" id="qrColorPicker" value="#238636">
  <label>Vibration feedback</label>
  <input type="checkbox" id="vibrateToggle" checked>
  <label>Beep sound</label>
  <input type="checkbox" id="beepToggle" checked>
  <label>Continuous scanning</label>
  <input type="checkbox" id="continuousToggle">
  <hr style="border:none; border-top:1px solid var(--border-color); margin:20px 0;">
  <small style="color:var(--placeholder-color);">Lars QR Tool ‚Ä¢ January 2026<br>Fully offline ‚Ä¢ Private</small>
  <button class="secondary" onclick="document.getElementById('actualSettingsPanel').style.display='none'">Close</button>
</div>

<div id="feedbackOverlay">
  <div class="card">
    <h3>Send Feedback</h3>
    <p style="margin:16px 0;">Love the app? Found a bug? Have an idea?<br>Let me know!</p>
    <textarea id="feedbackText" placeholder="Your message..."></textarea>
    <button onclick="sendFeedback()">Send Email</button>
    <button class="secondary" onclick="closeFeedback()">Cancel</button>
  </div>
</div>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");

let currentCanvas = null;
let logoImage = null;

function getQRColor() {
  return localStorage.getItem("qrColor") || "#238636";
}

function saveGeneratedToHistory(text) {
  let h = JSON.parse(localStorage.getItem("qrHistory") || "[]");
  h.unshift({text, time: new Date().toISOString()});
  if (h.length > 200) h.pop();
  localStorage.setItem("qrHistory", JSON.stringify(h));
}

function clearLogo() {
  logoImage = null;
  document.getElementById("logoUpload").value = "";
  if (document.getElementById("text").value.trim()) generate();
}

document.getElementById("logoUpload").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      logoImage = img;
      if (document.getElementById("text").value.trim()) generate();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

function generate() {
  const text = document.getElementById("text").value.trim();
  if (!text) return;

  const box = document.getElementById("qrcode");
  box.innerHTML = "";

  new QRCode(box, {
    text: text,
    width: 512,
    height: 512,
    colorDark: getQRColor(),
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  setTimeout(() => {
    const canvas = box.querySelector("canvas");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    if (logoImage) {
      const logoSize = canvas.width * 0.2;
      const x = (canvas.width - logoSize) / 2;
      const y = (canvas.height - logoSize) / 2;

      ctx.fillStyle = "#ffffff";
      ctx.beginPath();
      ctx.arc(canvas.width / 2, canvas.height / 2, logoSize / 2 + 10, 0, Math.PI * 2);
      ctx.fill();

      ctx.drawImage(logoImage, x, y, logoSize, logoSize);
    }

    currentCanvas = canvas;
    box.classList.remove("animate-in");
    void box.offsetWidth;
    box.classList.add("animate-in");
    saveGeneratedToHistory(text);
  }, 100);
}

async function pasteText() {
  try {
    const text = await navigator.clipboard.readText();
    document.getElementById("text").value = text;
    generate();
  } catch { alert("Clipboard access denied"); }
}

function downloadQR() {
  if (!currentCanvas) return alert("Generate a QR code first!");
  const a = document.createElement("a");
  a.download = "lars-qr.png";
  a.href = currentCanvas.toDataURL("image/png");
  a.click();
}

async function shareQR() {
  if (!currentCanvas) return alert("Generate a QR code first!");
  currentCanvas.toBlob(async blob => {
    const file = new File([blob], "lars-qr.png", {type: "image/png"});
    if (navigator.canShare && navigator.canShare({files: [file]})) await navigator.share({files: [file], title: "QR Code by Lars"});
    else alert("Sharing not supported");
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const colorPicker = document.getElementById("qrColorPicker");
  if (colorPicker) {
    colorPicker.value = getQRColor();
    colorPicker.addEventListener("change", e => {
      localStorage.setItem("qrColor", e.target.value);
      if (document.getElementById("text").value.trim()) generate();
    });
  }

  const larsBtn = document.getElementById("larsButton");
  const settingsBtn = document.getElementById("actualSettingsBtn");
  const larsMenu = document.getElementById("larsMenu");
  const settingsPanel = document.getElementById("actualSettingsPanel");

  if (larsBtn) larsBtn.onclick = e => { e.stopPropagation(); larsMenu.style.display = larsMenu.style.display === "block" ? "none" : "block"; settingsPanel.style.display = "none"; };
  if (settingsBtn) settingsBtn.onclick = e => { e.stopPropagation(); settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block"; larsMenu.style.display = "none"; };

  document.addEventListener("click", e => {
    if (larsMenu && !larsMenu.contains(e.target) && !larsBtn.contains(e.target)) larsMenu.style.display = "none";
    if (settingsPanel && !settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) settingsPanel.style.display = "none";
  });

  window.openFeedback = () => { larsMenu.style.display = "none"; document.getElementById("feedbackOverlay").style.display = "flex"; };
  window.closeFeedback = () => { document.getElementById("feedbackOverlay").style.display = "none"; document.getElementById("feedbackText").value = ""; };
  window.sendFeedback = () => {
    const msg = document.getElementById("feedbackText").value.trim();
    if (!msg) return alert("Please write a message!");
    window.location.href = `mailto:larslabs@atomicmail.io?subject=Lars%20QR%20Tool%20Feedback&body=${encodeURIComponent(msg)}`;
    closeFeedback();
  };
  window.openAbout = () => { larsMenu.style.display = "none"; alert("Lars QR Tool\n\nVersion 1.0 ‚Ä¢ January 2026\nFully offline ‚Ä¢ Private ‚Ä¢ Fast\nMade with passion üöÄ"); };
  window.openDonate = () => { larsMenu.style.display = "none"; window.open("https://buymeacoffee.com/larslabs", "_blank"); };

  document.getElementById("themeSelect")?.addEventListener("change", e => saveTheme(e.target.value));
  document.getElementById("langSelect")?.addEventListener("change", e => saveLang(e.target.value));
  document.getElementById("vibrateToggle")?.addEventListener("change", e => saveOption("vibrate", e.target.checked));
  document.getElementById("beepToggle")?.addEventListener("change", e => saveOption("beep", e.target.checked));
  document.getElementById("continuousToggle")?.addEventListener("change", e => saveOption("continuous", e.target.checked));

  generate();
});
</script>
</body>
</html>
